<template>
  <div>
    <div class="h-full flex flex-col max-w-5xl mx-auto">
      <div class="flex-1 space-y-8">
        <!-- Tokenç®¡ç†å¡ç‰‡ - ä»…åœ¨æœ‰Tokenæ—¶æ˜¾ç¤º -->
        <UCard v-if="guestStore.hasToken" class="shadow-lg bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 border border-emerald-200 dark:border-emerald-700">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="w-12 h-12 bg-gradient-to-br from-emerald-600 to-teal-600 rounded-lg flex items-center justify-center shadow-md">
                <UIcon name="heroicons:check-circle" class="w-6 h-6 text-white" />
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-stone-900 dark:text-white mb-2">
                Tokenå·²æ¿€æ´»
              </h3>
              <p class="text-stone-700 dark:text-stone-300 mb-3">
                å·²ä¸Šä¼  {{ guestStore.uploadCount }} å¼ å›¾ç‰‡ï¼Œæ— ä¸Šä¼ æ•°é‡å’Œæ—¶é—´é™åˆ¶ã€‚
              </p>
              <div class="flex flex-wrap gap-2">
                <UButton color="amber" variant="soft" @click="showTokenInfo = true">
                  <template #leading>
                    <UIcon name="heroicons:information-circle" />
                  </template>
                  Tokenè¯¦æƒ…
                </UButton>
                <UButton color="stone" variant="soft" @click="showTokenGenerator = true">
                  ç”Ÿæˆæ–°Token
                </UButton>
              </div>
            </div>
          </div>
        </UCard>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <UCard class="shadow-lg border border-stone-200 dark:border-neutral-700">
          <div
        class="relative border-2 border-dashed rounded-xl p-12 text-center transition-all"
        :class="[
          isDragging ? 'border-amber-500 bg-amber-50 dark:bg-amber-900/20' : 'border-stone-300 dark:border-neutral-600',
          uploading ? 'pointer-events-none opacity-50' : 'hover:border-amber-400 cursor-pointer'
        ]"
        @dragover.prevent="isDragging = true"
        @dragleave.prevent="isDragging = false"
        @drop.prevent="handleDrop"
        @click="triggerFileInput"
      >
        <input
          ref="fileInput"
          type="file"
          accept="image/*"
          multiple
          class="hidden"
          @change="handleFileSelect"
        />

        <!-- ä¸Šä¼ å›¾æ ‡å’Œæ–‡å­— -->
        <div v-if="!uploading" class="space-y-4">
          <div class="flex justify-center">
            <div class="w-20 h-20 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center transform hover:scale-105 transition-transform shadow-lg">
              <UIcon name="heroicons:cloud-arrow-up" class="w-12 h-12 text-white" />
            </div>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-stone-900 dark:text-white mb-2">
              æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ
            </h2>
            <p class="text-stone-600 dark:text-stone-400 mb-4">
              æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ / ç²˜è´´å‰ªè´´æ¿å›¾ç‰‡ (Ctrl+V)
            </p>
            <UButton size="lg" color="amber">
              é€‰æ‹©å›¾ç‰‡
            </UButton>
            <p class="text-sm text-gray-500 dark:text-gray-500 mt-4">
              æ”¯æŒ JPGã€PNGã€GIFã€WEBPï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 20MB
            </p>
          </div>
        </div>

        <!-- ä¸Šä¼ è¿›åº¦ -->
        <div v-else class="space-y-4">
          <div class="flex justify-center">
            <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
          </div>
          <div>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">
              {{ uploadProgress.label }}
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              {{ uploadProgress.percent }}%
            </p>
          </div>
          <UProgress :value="uploadProgress.percent" color="primary" />
          <UButton color="red" variant="soft" @click="cancelUpload">
            å–æ¶ˆä¸Šä¼ 
          </UButton>
            </div>
          </div>
        </UCard>

        <!-- ä¸Šä¼ ç»“æœ -->
        <UCard v-if="uploadedImages.length > 0" class="shadow-xl">
          <template #header>
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white">
            ä¸Šä¼ æˆåŠŸ ({{ uploadedImages.length }}å¼ )
          </h3>
          <UButton color="gray" variant="ghost" @click="clearResults">
            æ¸…ç©º
          </UButton>
        </div>
      </template>

      <!-- ç¼©ç•¥å›¾ç½‘æ ¼ -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div
          v-for="(image, index) in uploadedImages"
          :key="index"
          class="relative group aspect-square rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow"
        >
          <img
            :src="image.url"
            :alt="image.filename"
            class="w-full h-full object-cover"
          />
          <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
            <UButton
              icon="heroicons:eye"
              color="white"
              size="sm"
              @click="previewImage(image)"
            />
            <UButton
              icon="heroicons:clipboard-document"
              color="white"
              size="sm"
              @click="copyImageUrl(image.url)"
            />
          </div>
        </div>
      </div>

      <!-- é“¾æ¥æ ¼å¼æ ‡ç­¾é¡µ -->
      <div class="mt-6">
        <div class="flex gap-2 mb-4 border-b border-gray-200 dark:border-gray-700">
          <button
            v-for="(tab, index) in formatTabs"
            :key="index"
            @click="selectedFormat = index"
            :class="[
              'px-4 py-2 font-medium text-sm transition-colors',
              selectedFormat === index
                ? 'text-cyan-600 dark:text-cyan-400 border-b-2 border-cyan-600 dark:border-cyan-400'
                : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
            ]"
          >
            {{ tab.label }}
          </button>
        </div>
        <div class="space-y-4 py-4">
          <UTextarea
            :model-value="getFormattedLinks(formatTabs[selectedFormat].value)"
            readonly
            :rows="6"
            class="font-mono text-sm"
          />
          <UButton
            icon="heroicons:clipboard-document"
            color="primary"
            block
            @click="copyAllLinks(formatTabs[selectedFormat].value)"
          >
            å¤åˆ¶å…¨éƒ¨é“¾æ¥
              </UButton>
            </div>
          </div>
        </UCard>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ - å›ºå®šåœ¨åº•éƒ¨ -->
      <div class="mt-8 space-y-4">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">å®æ—¶ç»Ÿè®¡</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <UCard>
        <div class="text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">æ€»æ–‡ä»¶</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">
            {{ stats.totalFiles || '--' }}
          </p>
        </div>
      </UCard>
      <UCard>
        <div class="text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">å­˜å‚¨ç©ºé—´</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">
            {{ stats.totalSize || '--' }}
          </p>
        </div>
      </UCard>
      <UCard>
        <div class="text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">ä»Šæ—¥ä¸Šä¼ </p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">
            {{ stats.todayUploads || '--' }}
          </p>
        </div>
      </UCard>
      <UCard>
        <div class="text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">è¿è¡Œæ—¶é—´</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">
            {{ stats.uptime || '--' }}
          </p>
        </div>
      </UCard>
      </div>
    </div>

    <!-- Tokenç”Ÿæˆå™¨æ¨¡æ€æ¡† -->
    <UModal v-model="showTokenGenerator">
    <UCard>
        <template #header>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">ç”ŸæˆToken</h3>
            <UButton
              icon="heroicons:x-mark"
              color="gray"
              variant="ghost"
              @click="showTokenGenerator = false"
            />
          </div>
        </template>
        <div class="space-y-4">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            ç”Ÿæˆä¸“å±Tokenåå³å¯å¼€å§‹ä¸Šä¼ å›¾ç‰‡ã€‚Tokenä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡è®¿é—®æ—¶è‡ªåŠ¨æ¢å¤ã€‚
          </p>
          <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
            <div class="flex items-start gap-3">
              <UIcon name="heroicons:check-circle" class="w-5 h-5 text-green-600 dark:text-green-400 mt-0.5" />
              <div class="flex-1">
                <p class="text-sm font-medium text-green-900 dark:text-green-100 mb-1">æ— é™åˆ¶ä½¿ç”¨</p>
                <ul class="text-xs text-green-700 dark:text-green-300 space-y-1">
                  <li>â€¢ æ— ä¸Šä¼ æ•°é‡é™åˆ¶</li>
                  <li>â€¢ æ— æ—¶é—´é™åˆ¶ï¼Œæ°¸ä¹…æœ‰æ•ˆ</li>
                  <li>â€¢ å¯éšæ—¶æŸ¥çœ‹ä¸Šä¼ å†å²</li>
                </ul>
              </div>
            </div>
          </div>
          <UButton
            color="primary"
            block
            :loading="generatingToken"
            @click="handleGenerateToken"
          >
            ç”ŸæˆToken
          </UButton>
        </div>
      </UCard>
    </UModal>

    <!-- Tokenä¿¡æ¯æ¨¡æ€æ¡† -->
    <UModal v-model="showTokenInfo">
      <UCard>
        <template #header>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Tokenç®¡ç†</h3>
            <UButton
              icon="heroicons:x-mark"
              color="gray"
              variant="ghost"
              @click="showTokenInfo = false"
            />
          </div>
        </template>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              æ‚¨çš„Token
            </label>
            <div class="flex gap-2">
              <UInput
                :model-value="guestStore.token"
                readonly
                class="flex-1 font-mono text-xs"
              />
              <UButton
                icon="heroicons:clipboard-document"
                color="gray"
                @click="copyToken"
              />
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„Token
            </p>
          </div>
          <div class="p-4 bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 rounded-lg border border-cyan-200 dark:border-cyan-800">
            <div class="text-center">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">å·²ä¸Šä¼ å›¾ç‰‡</p>
              <p class="text-3xl font-bold text-cyan-600 dark:text-cyan-400">
                {{ guestStore.uploadCount }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">æ— æ•°é‡é™åˆ¶ Â· æ°¸ä¹…æœ‰æ•ˆ</p>
            </div>
          </div>
          <div class="space-y-2">
            <UButton color="cyan" variant="soft" block @click="() => { showTokenInfo = false; showTokenHistory = true }">
              <template #leading>
                <UIcon name="heroicons:clock" />
              </template>
              æŸ¥çœ‹ä¸Šä¼ å†å²
            </UButton>
            <UButton color="gray" variant="outline" block @click="handleRefreshToken">
              <template #leading>
                <UIcon name="heroicons:arrow-path" />
              </template>
              åˆ·æ–°Token
            </UButton>
          </div>
        </div>
      </UCard>
    </UModal>

    <!-- Tokenè¯´æ˜æ¨¡æ€æ¡† -->
    <UModal v-model="showGuestInfo">
      <UCard>
        <template #header>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">TokenåŠŸèƒ½è¯´æ˜</h3>
            <UButton
              icon="heroicons:x-mark"
              color="gray"
              variant="ghost"
              @click="showGuestInfo = false"
            />
          </div>
        </template>
        <div class="space-y-4">
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">âœ¨ ä»€ä¹ˆæ˜¯Tokenï¼Ÿ</h4>
            <p class="text-gray-600 dark:text-gray-400 text-sm">
              Tokenæ˜¯æ‚¨çš„ä¸“å±å‡­è¯ï¼Œç”¨äºç®¡ç†å’Œè¿½è¸ªæ‚¨ä¸Šä¼ çš„å›¾ç‰‡ã€‚ç”ŸæˆTokenåï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸Šä¼ å†å²ã€ç®¡ç†å›¾ç‰‡ã€‚
            </p>
          </div>
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">ğŸ¯ ä¸»è¦åŠŸèƒ½</h4>
            <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-sm space-y-1">
              <li>æŸ¥çœ‹ä¸Šä¼ å†å²è®°å½•</li>
              <li>æ— ä¸Šä¼ æ•°é‡é™åˆ¶</li>
              <li>æ°¸ä¹…æœ‰æ•ˆï¼Œæ— æ—¶é—´é™åˆ¶</li>
              <li>éšæ—¶åˆ·æ–°è·å–æ–°Token</li>
              <li>Tokenè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡è®¿é—®è‡ªåŠ¨æ¢å¤</li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">ğŸ”’ å®‰å…¨æç¤º</h4>
            <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-sm space-y-1">
              <li>Tokenä¼šè‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨ä¸­</li>
              <li>Tokenä¸¢å¤±åæ— æ³•æ‰¾å›ï¼Œä½†å¯é‡æ–°ç”Ÿæˆ</li>
              <li>åˆ·æ–°Tokenä¼šæ¸…é™¤æ—§Tokenå¹¶ç”Ÿæˆæ–°çš„</li>
              <li>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„Token</li>
            </ul>
          </div>
          <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
            <UButton color="primary" block @click="() => { showGuestInfo = false; showTokenGenerator = true }">
              ç”ŸæˆToken
            </UButton>
          </div>
        </div>
      </UCard>
    </UModal>

    <!-- ä¸Šä¼ å†å²æ¨¡æ€æ¡† -->
    <UModal v-model="showTokenHistory">
      <UCard>
        <template #header>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">ä¸Šä¼ å†å²</h3>
            <UButton
              icon="heroicons:x-mark"
              color="gray"
              variant="ghost"
              @click="showTokenHistory = false"
            />
          </div>
        </template>
        <div class="space-y-4">
          <div v-if="tokenHistory.length > 0" class="space-y-3 max-h-96 overflow-y-auto">
            <div
              v-for="(item, index) in tokenHistory"
              :key="index"
              class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:shadow-md transition-shadow"
            >
              <img
                :src="item.image_url"
                :alt="item.original_filename"
                class="w-12 h-12 object-cover rounded"
              />
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                  {{ item.original_filename }}
                </p>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                  {{ item.created_at }}
                </p>
              </div>
              <UButton
                icon="heroicons:clipboard-document"
                color="gray"
                variant="ghost"
                size="sm"
                @click="copyImageUrl(item.image_url)"
              />
            </div>
          </div>
          <div v-else-if="!loadingHistory" class="text-center py-8 text-gray-500 dark:text-gray-400">
            æš‚æ— ä¸Šä¼ è®°å½•
          </div>
          <div v-else class="text-center py-8">
            <div class="inline-block w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
          </div>
        </div>
      </UCard>
    </UModal>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <UModal v-model="previewOpen">
      <UCard>
        <template #header>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">å›¾ç‰‡é¢„è§ˆ</h3>
            <UButton
              icon="heroicons:x-mark"
              color="gray"
              variant="ghost"
              @click="previewOpen = false"
            />
          </div>
        </template>
        <div v-if="previewingImage">
          <img
            :src="previewingImage.url"
            :alt="previewingImage.filename"
            class="w-full rounded-lg"
          />
          <div class="mt-4 space-y-2">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              <strong>æ–‡ä»¶å:</strong> {{ previewingImage.filename }}
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              <strong>URL:</strong>
              <code class="text-xs bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                {{ previewingImage.url }}
              </code>
            </p>
          </div>
        </div>
      </UCard>
    </UModal>
  </div>
</template>

<script setup lang="ts">
const toast = useToast()
const { uploadImages, getStats } = useImageApi()
const guestStore = useGuestTokenStore()
const config = useRuntimeConfig()

// çŠ¶æ€
const isDragging = ref(false)
const uploading = ref(false)
const uploadProgress = ref({ label: 'ä¸Šä¼ ä¸­...', percent: 0 })
const uploadedImages = ref<any[]>([])
const stats = ref<any>({})
const fileInput = ref<HTMLInputElement>()
const selectedFormat = ref(0)
const previewOpen = ref(false)
const previewingImage = ref<any>(null)
const showGuestInfo = ref(false)
const showTokenGenerator = ref(false)
const showTokenInfo = ref(false)
const showTokenHistory = ref(false)
const tokenConfig = ref({
  upload_limit: 100,
  expires_days: 30
})
const generatingToken = ref(false)
const tokenHistory = ref<any[]>([])
const loadingHistory = ref(false)

// æ ¼å¼æ ‡ç­¾
const formatTabs = [
  { label: 'URL', value: 'url' },
  { label: 'Markdown', value: 'markdown' },
  { label: 'HTML', value: 'html' },
  { label: 'BBCode', value: 'bbcode' }
]

// è§¦å‘æ–‡ä»¶é€‰æ‹©
const triggerFileInput = () => {
  fileInput.value?.click()
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement
  if (target.files) {
    handleFiles(Array.from(target.files))
  }
}

// å¤„ç†æ‹–æ”¾
const handleDrop = (event: DragEvent) => {
  isDragging.value = false
  if (event.dataTransfer?.files) {
    handleFiles(Array.from(event.dataTransfer.files))
  }
}

// ç”ŸæˆToken
const handleGenerateToken = async () => {
  generatingToken.value = true
  try {
    await guestStore.generateToken(tokenConfig.value)
    showTokenGenerator.value = false
    toast.add({
      title: 'æˆåŠŸ',
      description: 'Tokenå·²ç”Ÿæˆ',
      color: 'green'
    })
  } catch (error: any) {
    toast.add({
      title: 'ç”Ÿæˆå¤±è´¥',
      description: error.message,
      color: 'red'
    })
  } finally {
    generatingToken.value = false
  }
}

// åˆ·æ–°Token
const handleRefreshToken = async () => {
  if (!confirm('åˆ·æ–°Tokenå°†æ¸…é™¤å½“å‰Tokenå¹¶ç”Ÿæˆæ–°çš„Tokenï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
    return
  }
  try {
    showTokenInfo.value = false
    await guestStore.refreshToken(tokenConfig.value)
    toast.add({
      title: 'æˆåŠŸ',
      description: 'Tokenå·²åˆ·æ–°',
      color: 'green'
    })
  } catch (error: any) {
    toast.add({
      title: 'åˆ·æ–°å¤±è´¥',
      description: error.message,
      color: 'red'
    })
  }
}

// æ¸…é™¤Token
const handleClearToken = () => {
  if (confirm('ç¡®å®šè¦æ¸…é™¤Tokenå—ï¼Ÿæ¸…é™¤åå°†æ— æ³•æŸ¥çœ‹ä¸Šä¼ å†å²ã€‚')) {
    guestStore.clearToken()
    tokenHistory.value = []
    toast.add({
      title: 'å·²æ¸…é™¤',
      description: 'Tokenå·²æ¸…é™¤',
      color: 'green'
    })
  }
}

// å¤åˆ¶Token
const copyToken = async () => {
  try {
    // ä¼˜å…ˆä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
    await navigator.clipboard.writeText(guestStore.token)
    toast.add({
      title: 'å·²å¤åˆ¶',
      description: 'Tokenå·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
      color: 'green'
    })
  } catch (err) {
    // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
    try {
      const textArea = document.createElement('textarea')
      textArea.value = guestStore.token
      textArea.style.position = 'fixed'
      textArea.style.left = '-999999px'
      textArea.style.top = '-999999px'
      document.body.appendChild(textArea)
      textArea.focus()
      textArea.select()
      const successful = document.execCommand('copy')
      document.body.removeChild(textArea)

      if (successful) {
        toast.add({
          title: 'å·²å¤åˆ¶',
          description: 'Tokenå·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
          color: 'green'
        })
      } else {
        throw new Error('å¤åˆ¶å¤±è´¥')
      }
    } catch (fallbackErr) {
      toast.add({
        title: 'å¤åˆ¶å¤±è´¥',
        description: 'è¯·æ‰‹åŠ¨å¤åˆ¶Token',
        color: 'red'
      })
      console.error('å¤åˆ¶Tokenå¤±è´¥:', fallbackErr)
    }
  }
}

// åŠ è½½ä¸Šä¼ å†å²
const loadTokenHistory = async () => {
  if (!guestStore.hasToken) return

  loadingHistory.value = true
  try {
    const data = await guestStore.getUploads(1, 20)
    tokenHistory.value = data.uploads
  } catch (error: any) {
    toast.add({
      title: 'åŠ è½½å¤±è´¥',
      description: error.message,
      color: 'red'
    })
  } finally {
    loadingHistory.value = false
  }
}

// ç›‘å¬å†å²æ¨¡æ€æ¡†æ‰“å¼€
watch(showTokenHistory, (newVal) => {
  if (newVal) {
    loadTokenHistory()
  }
})

// å¤åˆ¶å›¾ç‰‡URL
const copyImageUrl = async (url: string) => {
  await navigator.clipboard.writeText(url)
  toast.add({
    title: 'å·²å¤åˆ¶',
    description: 'URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
    color: 'green'
  })
}

// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
const handleFiles = async (files: File[]) => {
  if (files.length === 0) return

  // Tokenæ£€æŸ¥ï¼ˆå¦‚æœæœ‰Tokenåˆ™ä½¿ç”¨Tokenä¸Šä¼ ï¼‰
  // å·²ç§»é™¤ä¸Šä¼ æ¬¡æ•°é™åˆ¶æ£€æŸ¥
  // if (guestStore.hasToken) {
  //   if (guestStore.remainingUploads <= 0) {
  //     toast.add({
  //       title: 'ä¸Šä¼ æ¬¡æ•°å·²ç”¨å®Œ',
  //       description: 'è¯·åˆ·æ–°Tokenä»¥è·å–æ–°çš„ä¸Šä¼ æ¬¡æ•°',
  //       color: 'red'
  //     })
  //     return
  //   }

  //   // é™åˆ¶ä¸Šä¼ æ•°é‡
  //   const maxFiles = Math.min(files.length, guestStore.remainingUploads)
  //   if (files.length > maxFiles) {
  //     toast.add({
  //       title: 'æç¤º',
  //       description: `å‰©ä½™ä¸Šä¼ æ¬¡æ•°ä¸è¶³ï¼Œåªèƒ½ä¸Šä¼ ${maxFiles}å¼ å›¾ç‰‡`,
  //       color: 'orange'
  //     })
  //     files = files.slice(0, maxFiles)
  //   }
  // }

  // éªŒè¯æ–‡ä»¶
  const validFiles = files.filter(file => {
    if (!file.type.startsWith('image/')) {
      toast.add({ title: 'é”™è¯¯', description: `${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`, color: 'red' })
      return false
    }
    if (file.size > 20 * 1024 * 1024) {
      toast.add({ title: 'é”™è¯¯', description: `${file.name} è¶…è¿‡ 20MB`, color: 'red' })
      return false
    }
    return true
  })

  if (validFiles.length === 0) return

  uploading.value = true
  uploadProgress.value = { label: 'ä¸Šä¼ ä¸­...', percent: 0 }

  try {
    let results = []

    if (guestStore.hasToken) {
      // ä½¿ç”¨Tokenä¸Šä¼ 
      for (let i = 0; i < validFiles.length; i++) {
        const file = validFiles[i]
        uploadProgress.value = {
          label: `ä¸Šä¼ ä¸­ (${i + 1}/${validFiles.length})`,
          percent: Math.round((i / validFiles.length) * 100)
        }

        const formData = new FormData()
        formData.append('file', file)

        const response = await $fetch<any>(`${config.public.apiBase}/api/auth/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${guestStore.token}`
          },
          body: formData
        })

        if (response.success) {
          results.push(response.data)
        }
      }

      // åˆ·æ–°tokenä¿¡æ¯
      await guestStore.verifyToken()
    } else {
      // æ™®é€šä¸Šä¼ ï¼ˆæ— Tokenï¼‰
      results = await uploadImages(validFiles, (progress) => {
        uploadProgress.value = progress
      })
    }

    uploadProgress.value = { label: 'å®Œæˆ', percent: 100 }
    uploadedImages.value = results

    toast.add({
      title: 'æˆåŠŸ',
      description: `æˆåŠŸä¸Šä¼  ${results.length} å¼ å›¾ç‰‡`,
      color: 'green'
    })

    // åˆ·æ–°ç»Ÿè®¡
    await loadStats()
  } catch (error: any) {
    toast.add({
      title: 'ä¸Šä¼ å¤±è´¥',
      description: error.data?.error || error.message || 'æœªçŸ¥é”™è¯¯',
      color: 'red'
    })
  } finally {
    uploading.value = false
  }
}

// å–æ¶ˆä¸Šä¼ 
const cancelUpload = () => {
  uploading.value = false
  uploadProgress.value = { label: 'ä¸Šä¼ ä¸­...', percent: 0 }
}

// æ¸…ç©ºç»“æœ
const clearResults = () => {
  uploadedImages.value = []
}

// è·å–æ ¼å¼åŒ–é“¾æ¥
const getFormattedLinks = (format: string) => {
  return uploadedImages.value.map(img => {
    switch (format) {
      case 'url':
        return img.url
      case 'markdown':
        return `![${img.filename}](${img.url})`
      case 'html':
        return `<img src="${img.url}" alt="${img.filename}" />`
      case 'bbcode':
        return `[img]${img.url}[/img]`
      default:
        return img.url
    }
  }).join('\n')
}

// å¤åˆ¶æ‰€æœ‰é“¾æ¥
const copyAllLinks = async (format: string) => {
  const text = getFormattedLinks(format)
  await navigator.clipboard.writeText(text)
  toast.add({
    title: 'å·²å¤åˆ¶',
    description: 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
    color: 'green'
  })
}

// é¢„è§ˆå›¾ç‰‡
const previewImage = (image: any) => {
  previewingImage.value = image
  previewOpen.value = true
}

// åŠ è½½ç»Ÿè®¡ä¿¡æ¯
const loadStats = async () => {
  try {
    stats.value = await getStats()
  } catch (error) {
    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error)
  }
}

// å®šæ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
let statsRefreshInterval: NodeJS.Timeout | null = null

// å¤„ç†å‰ªè´´æ¿ç²˜è´´
const handlePaste = (event: ClipboardEvent) => {
  const items = event.clipboardData?.items
  if (!items) return

  const files: File[] = []
  for (let i = 0; i < items.length; i++) {
    const item = items[i]
    if (item.type.startsWith('image/')) {
      const file = item.getAsFile()
      if (file) {
        files.push(file)
      }
    }
  }

  if (files.length > 0) {
    event.preventDefault()
    handleFiles(files)
  }
}

// é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡å’Œæ¢å¤token
onMounted(async () => {
  await loadStats()
  await guestStore.restoreToken()

  // æ·»åŠ å…¨å±€ç²˜è´´äº‹ä»¶ç›‘å¬
  window.addEventListener('paste', handlePaste)

  // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
  statsRefreshInterval = setInterval(() => {
    loadStats()
  }, 30000)
})

// é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬
onUnmounted(() => {
  if (statsRefreshInterval) {
    clearInterval(statsRefreshInterval)
  }
  // ç§»é™¤ç²˜è´´äº‹ä»¶ç›‘å¬
  window.removeEventListener('paste', handlePaste)
})
</script>
